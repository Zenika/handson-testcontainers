<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Architecture | Dockerisez vos tests d’intégration</title>
    <meta name="description" content="Mise en place de testcontainers pour l&#39;application Spring Petclinic">
    
    
    <link rel="preload" href="/handson-testcontainers/assets/css/0.styles.91419a4e.css" as="style"><link rel="preload" href="/handson-testcontainers/assets/js/app.a3088946.js" as="script"><link rel="preload" href="/handson-testcontainers/assets/js/2.cbe199e7.js" as="script"><link rel="preload" href="/handson-testcontainers/assets/js/6.c8268d99.js" as="script"><link rel="prefetch" href="/handson-testcontainers/assets/js/10.cbb91124.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/11.96fd053a.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/3.9e8a07c9.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/4.2a3280e3.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/5.0ebf20bb.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/7.a35d126c.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/8.4a1a83bb.js"><link rel="prefetch" href="/handson-testcontainers/assets/js/9.84e18139.js">
    <link rel="stylesheet" href="/handson-testcontainers/assets/css/0.styles.91419a4e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/handson-testcontainers/" class="home-link router-link-active"><!----> <span class="site-name">Dockerisez vos tests d’intégration</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/vgallet/handson-testcontainers" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/vgallet/handson-testcontainers" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/handson-testcontainers/1_GETTING_STARTED.html" class="sidebar-link">Getting Started</a></li><li><a href="/handson-testcontainers/2_ARCHITECTURE.html" class="active sidebar-link">Architecture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/handson-testcontainers/2_ARCHITECTURE.html#tests-initiaux" class="sidebar-link">Tests initiaux</a></li><li class="sidebar-sub-header"><a href="/handson-testcontainers/2_ARCHITECTURE.html#amelioration-des-tests" class="sidebar-link">Amélioration des Tests</a></li><li class="sidebar-sub-header"><a href="/handson-testcontainers/2_ARCHITECTURE.html#verification" class="sidebar-link">Vérification</a></li></ul></li><li><a href="/handson-testcontainers/3_MYSQL_CONTAINER.html" class="sidebar-link">MySQL Container</a></li><li><a href="/handson-testcontainers/4_WEB_BROWSER_CONTAINER.html" class="sidebar-link">Web Browser Container</a></li><li><a href="/handson-testcontainers/5_PAGE_PATTERN.html" class="sidebar-link">Page Pattern (Partie Bonus)</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="architecture"><a href="#architecture" aria-hidden="true" class="header-anchor">#</a> Architecture</h1> <p>L'application Spring PetClinic est une application Spring Boot classique avec une architecture SOA (Service Oriented Architecture).</p> <p><img src="architecture.png" alt="Architecture SOA&amp;"></p> <p>Les classes se terminant par <code>*Controller</code> sont les endpoints HTTP exposant des services permettant de manipuler les entités.</p> <p>On retrouve par exemple les classes <code>PetController</code>, <code>OwnerController</code>, <code>VetController</code>, etc.</p> <p>Ces derniers font appel à la couche DAO qui est responsable de communiquer avec la base de données.</p> <p>La couche DAO est ici représentée par les interfaces se terminant par <code>*Repository</code>.</p> <p>Ce sont des interfaces qui étendent l'interface <code>org.springframework.data.repository.Repository</code>. Le composant <a href="https://spring.io/projects/spring-data" target="_blank" rel="noopener noreferrer">Spring Data<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> fournira l'implémentation au runtime.</p> <p>Attention à ne pas les confondre avec l'annotation <code>org.springframework.stereotype.Repository</code>.</p> <p>Par contre, il est également possible d'ajouter ces propres méthodes d'accès à la base de données grâce à l'annotation <code>@Query</code>.</p> <p>Un exemple de cette utilisation se trouve par exemple dans la classe <code>OwnerRepository</code> :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT DISTINCT owner FROM Owner owner left join fetch owner.pets WHERE owner.lastName LIKE :lastName%&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>readOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Owner</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByLastName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;lastName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Ces méthodes de requêtages sont testées dans les classe de tests se terminant par <code>*RepositoryTests</code>. Par exemple <code>OwnerRepositoryTests</code>.</p> <h2 id="tests-initiaux"><a href="#tests-initiaux" aria-hidden="true" class="header-anchor">#</a> Tests initiaux</h2> <p>Actuellement l'ensemble des tests <code>*RepositoryTests</code> étendent une classe commune nommée <code>AbstractRepositoryTest</code>.</p> <p>Cette classe permet un chargement allégé du context Spring
avec uniquement les interfaces des repositories et la base de donnée Inmemory par défaut fournit par <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-testing.html" target="_blank" rel="noopener noreferrer">Spring Boot Test<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Pour bien démarrer, vous pouvez lancer la suite de test et mesurez le temps d'exécution.</p> <h2 id="amelioration-des-tests"><a href="#amelioration-des-tests" aria-hidden="true" class="header-anchor">#</a> Amélioration des Tests</h2> <blockquote><p>L'objectif de cette partie est d'utiliser une base de donnée similaire à celle utilisée en production par l'application.<br>
Pour cet atelier nous allons utiliser le SGBD MYSQL.</p></blockquote> <p>Afin de commencer la migration vers des tests utilisant une base de données MySQL, il vous faut tout d'abord ajouter la dépendance vers le driver Mysql :</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Puis dans un second temps afin de prévoir l'interopérabilité avec Testcontainers il faut ajouter la librairie <code>org.testcontainers:testcontainers</code>.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.testcontainers<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>testcontainers<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.11.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Ensuite il vous faut modifier la configuration pour utiliser la nouvelle base de donnée. Ceci ce déroule en trois étapes :</p> <ul><li>Modification des properties de configuration de la datasource de l'application</li> <li>Modification de la classe commune <code>AbstractRepositoryTest</code> pour utiliser la Datasource nouvellement configuré</li> <li>Ajouter une première version de <code>GenericContainer</code> (objet java fourni par la librairie Testcontainers représentant un conteneur docker)</li></ul> <h3 id="modification-des-properties"><a href="#modification-des-properties" aria-hidden="true" class="header-anchor">#</a> Modification des properties</h3> <p>Afin de configurer les tests pour qu'ils utilisent la datasource MySQL, vous devez faire en sorte d'ajouter ces nouvelles propriétés de configuration :</p> <div class="language- extra-class"><pre class="language-text"><code>spring.datasource.url=jdbc:mysql://localhost/petclinic
spring.datasource.username=petclinic,
spring.datasource.password=petclinic,
spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
</code></pre></div><div class="tip custom-block"><p>Il existe plusieurs manières de surcharger des propriétés de configuration, aussi bien par fichier que par annotation.</p></div> <details><summary>Afficher la réponse</summary> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span><span class="token punctuation">(</span>
    properties <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;spring.datasource.url=jdbc:mysql://localhost/petclinic&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;spring.datasource.username=petclinic&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;spring.datasource.password=petclinic&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    includeFilters <span class="token operator">=</span> <span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">.</span><span class="token class-name">Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span>ASSIGNABLE_TYPE<span class="token punctuation">,</span> classes <span class="token operator">=</span> <span class="token class-name">Repository</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractRepositoryTests</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></details> <h3 id="utilisation-de-la-nouvelle-datasource"><a href="#utilisation-de-la-nouvelle-datasource" aria-hidden="true" class="header-anchor">#</a> Utilisation de la nouvelle dataSource</h3> <p>Par ailleurs, l'annotation <code>@DataJpaTest</code> de la dépendance Spring Boot Test se charge de créer tout le nécessaire pour avoir un contexte de test unitaire opérationnel.
C'est-à-dire qu'elle va notamment créer une base de données en mémoire (cf : ligne 12 ci-dessous).</p> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token annotation punctuation">@BootstrapWith</span><span class="token punctuation">(</span><span class="token class-name">DataJpaTestContextBootstrapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">SpringExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@OverrideAutoConfiguration</span><span class="token punctuation">(</span>enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@TypeExcludeFilters</span><span class="token punctuation">(</span><span class="token class-name">DataJpaTypeExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span>
<span class="token annotation punctuation">@AutoConfigureCache</span>
<span class="token annotation punctuation">@AutoConfigureDataJpa</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span>
<span class="token annotation punctuation">@AutoConfigureTestEntityManager</span>
<span class="token annotation punctuation">@ImportAutoConfiguration</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">DataJpaTest</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... TRUNCATED ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vous devez donc faire en sorte de surcharger ce comportement pour ne pas avoir de base de données en mémoire.</p> <details><summary>Afficher la réponse</summary> <p>Pour cela ajouter l'annotation suivante :</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase</span><span class="token punctuation">.</span><span class="token class-name">Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
</code></pre></div></details> <div class="tip custom-block"><p>Cette annotation permet de dire à SpringBoot Test de ne surcharger aucune datasource lors des tests</p></div> <hr> <h2 id="verification"><a href="#verification" aria-hidden="true" class="header-anchor">#</a> Vérification</h2> <p>Lancez les tests ! S'ils échouent avec une belle exception</p> <div class="danger custom-block"><p class="custom-block-title">Connexion refusée</p> <p>Caused by: java.net.ConnectException: Connexion refusée (Connection refused)</p></div> <p>c'est que la base de données en mémoire a bien été désactivé au profit de la base Mysql. Plus aucun des tests de repository ne fonctionnent ! 😃</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/vgallet/handson-testcontainers/edit/master/tps/2_ARCHITECTURE.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/handson-testcontainers/1_GETTING_STARTED.html" class="prev">Getting Started</a></span> <span class="next"><a href="/handson-testcontainers/3_MYSQL_CONTAINER.html">MySQL Container</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/handson-testcontainers/assets/js/app.a3088946.js" defer></script><script src="/handson-testcontainers/assets/js/2.cbe199e7.js" defer></script><script src="/handson-testcontainers/assets/js/6.c8268d99.js" defer></script>
  </body>
</html>
